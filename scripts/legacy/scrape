#!/bin/bash
#
# Interactive TikTok Scraper
# Just run: ./scrape
#

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "üéØ TikTok Tracker"
echo "================"
echo ""

# Check for accounts.csv
if [ ! -f "accounts.csv" ]; then
    echo "‚ùå Error: accounts.csv not found"
    echo ""
    echo "Please create accounts.csv with your TikTok accounts:"
    echo "  Account"
    echo "  beaujenkins"
    echo "  codyjames6.7"
    echo "  ..."
    echo ""
    exit 1
fi

# Count accounts
ACCOUNT_COUNT=$(tail -n +2 accounts.csv | grep -v '^$' | wc -l | tr -d ' ')
echo -e "${GREEN}Found:${NC} accounts.csv (${ACCOUNT_COUNT} accounts)"

# Check for songs.csv
MODE="full_catalog"
SONG_COUNT=0
if [ -f "songs.csv" ]; then
    SONG_COUNT=$(tail -n +2 songs.csv | grep -v '^$' | wc -l | tr -d ' ')
    MODE="filtered"
    echo -e "${GREEN}Found:${NC} songs.csv (${SONG_COUNT} songs) - Will run in ${BLUE}FILTERED${NC} mode"
    echo -e "       ${YELLOW}(Remove songs.csv to scrape ALL songs instead)${NC}"
else
    echo -e "${YELLOW}Note:${NC}  songs.csv not found - Will run in ${BLUE}FULL CATALOG${NC} mode"
    echo -e "       ${YELLOW}(Add songs.csv to filter by specific songs)${NC}"
fi

echo ""

# Prompt for start date
echo -n "üìÖ Start date (YYYY-MM-DD) or press Enter for all time: "
read START_DATE

# Validate date format if provided
if [ ! -z "$START_DATE" ]; then
    if ! [[ $START_DATE =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo "‚ùå Invalid date format. Use YYYY-MM-DD (e.g., 2025-10-14)"
        exit 1
    fi
fi

# Prompt for video limit
echo -n "üìä Video limit per account (default 500): "
read VIDEO_LIMIT
VIDEO_LIMIT=${VIDEO_LIMIT:-500}

# Validate video limit
if ! [[ $VIDEO_LIMIT =~ ^[0-9]+$ ]]; then
    echo "‚ùå Invalid number"
    exit 1
fi

# Prompt for campaign name
echo -n "üìù Campaign name (for output file): "
read CAMPAIGN_NAME

if [ -z "$CAMPAIGN_NAME" ]; then
    # Generate default name
    CAMPAIGN_NAME="scrape_$(date +%Y%m%d_%H%M%S)"
fi

# Clean campaign name (remove spaces, special chars)
CAMPAIGN_NAME=$(echo "$CAMPAIGN_NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')

echo ""
echo "================================================================================================"
echo ""
echo "Starting scrape with settings:"
echo "  Mode: $MODE"
echo "  Accounts: $ACCOUNT_COUNT"
if [ "$MODE" = "filtered" ]; then
    echo "  Songs to match: $SONG_COUNT"
fi
if [ ! -z "$START_DATE" ]; then
    echo "  Start date: $START_DATE"
else
    echo "  Start date: All time"
fi
echo "  Video limit: $VIDEO_LIMIT per account"
echo "  Campaign: $CAMPAIGN_NAME"
echo ""
echo "================================================================================================"
echo ""

# Activate venv if exists
if [ -d "venv" ]; then
    source venv/bin/activate
fi

# Build Python command
PYTHON_CMD="python3 unified_scraper.py --accounts accounts.csv --limit $VIDEO_LIMIT --output $CAMPAIGN_NAME"

if [ "$MODE" = "filtered" ]; then
    PYTHON_CMD="$PYTHON_CMD --songs songs.csv"
fi

if [ ! -z "$START_DATE" ]; then
    PYTHON_CMD="$PYTHON_CMD --start-date $START_DATE"
fi

# Run the scraper
$PYTHON_CMD

echo ""
echo "================================================================================================"
echo "‚úÖ Scrape Complete!"
echo "================================================================================================"
echo ""
